---
title: 'Redis 持久化'
tags:
    - Redis
date: '2022-11-11'
categories:
    - 数据库
draft: false
---


## 简介

Redis 运行时是将数据保存在内存中的，如果服务器宕机或者重启，内存中的数据必然会丢失。所以，必须要把数据持久化到磁盘，以便服务器故障时进行数据恢复。

Redis持久化提供了两种方式，RDB（RedisDB）和 AOF（Appendonly File）。

## RDB

RDB 就是在特定的条件下，将 Redis 的内存数据快照以二进制的方式保存到磁盘，文件名称 `dump.rdb` 。

调用 fork 方式创建子进程进行数据的持久化，所以会保留了持久化开始时刻的数据状况。

关于 RDB，Redis提供了2种方式：
- 命令：可以通过 `save` （阻塞）和 `bgsave` 命令，触发持久化写文件操作。
- 配置文件：
    ```
    # save <seconds> <changes>
    # save ""
    save 900 1 # 900 秒有 1 个 key 在被修改时持久化
    save 300 10
    save 60 10000

    rdbcompression yes # 默认开启数据压缩
    ```

优点：
1. 适合大规模的数据恢复。
2. 如果业务对数据完整性和一致性要求不高，RDB是很好的选择。

缺点：
1. 数据的完整性和一致性不高，因为RDB可能在最后一次备份时宕机了。
2. 备份时占用内存，因为 Redis 在备份时会独立创建一个子进程，将数据写入到一个临时文件（此时内存中的数据是原来的两倍哦），最后再将临时文件替换之前的备份文件。

## AOF

AOF Redis 默认不开启。它的出现是为了弥补 RDB 的不足（数据的不一致性），所以它采用日志的形式来记录每个写操作，并追加到文件中。Redis 重启的会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。。

为了降低IO消耗，AOF写文件时，会先将数据写到缓冲区，然后再把缓冲区的内容 flush 到磁盘，这个过程叫做 fsync。

AOF 的 flush 频率控制：
```
appendfsync always //每次写操作都flush，影响性能
appendfsync everysec //每秒flush
appendfsync no //消极等待OS刷新(一般30s),可能丢失数据
```

### AOF 重写

前面也说到了，AOF的工作原理是将写操作追加到文件中，文件的冗余内容会越来越多。所以聪明的 Redis 新增了重写机制。当 AOF 文件的大小超过所设定的阈值时，Redis 就会对 AOF 文件的内容压缩。

重写的原理：Redis 会fork出一条新进程，读取内存中的数据，并重新写到一个临时文件中。并没有读取旧文件（你都那么大了，我还去读你？？？ o(ﾟДﾟ)っ傻啊！）。最后替换旧的aof文件。

触发机制：当 AOF 文件大小是上次 rewrite 后大小的一倍且文件大于 64M 时触发。这里的“一倍”和“64M”可以通过配置文件修改。

触发机制的配置参数：
```
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

优点：数据的完整性和一致性更高

缺点：因为AOF记录的内容多，文件会越来越大，数据恢复也会越来越慢。