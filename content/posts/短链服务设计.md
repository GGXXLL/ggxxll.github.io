---
title: '短链服务设计'
tags:
    - 设计
date: '2022-11-09'
categories:
    - 后端
draft: true
---

### 需求

设计一个服务用于将长链接转换为短链接，服务设计需求如下：

- 唯一性：所有短链接应该唯一
- 不可预测：生成的短链接应该是不可预测的
- 持续时间：短链接可设定为永久，或者指定过期时间，默认是会过期的
- 定制化：用户可以自定义短链接

### 原理

当客户端访问短链接时，短链接服务查询到对应的长链接，设置到请求头中的 `location`，返回 HTTP 状态码 `301` 或 `302`进行重定向。
- 301：代表永久性转移。浏览器会缓存重定向后的地址，可以减少对短链接服务的请求。
- 302：代表暂时性转移。每次请求都需要获取服务端返回的重定向地址，可以利用该特性统计短链的请求次数等。

所以如果不需要短链服务进行数据统计，可以使用 `301` 状态码。一般情况下，建议选择使用 `302` 状态码。

### 短链接生成和下发

1. 使用自增字段。
2. 使用常见的 base64 编码。
3. 使用 MD5, SHA-1等 Hash。在不需要保证数据加密安全的情况下，推荐使用 Google 的 `MurmurHash` 算法，一种非加密型哈希函数，与其它流行的哈希函数相比，对于长度较长的 key ，`MurmurHash` 的随机分布特征表现更良好，发生 Hash 碰撞的几率更低。

可以使用同步生成的方式下发短链，即请求到达服务端时，进行 hash 生成短链。在短链冲突的情况下，可能需要多次 hash。

使用异步生成方式，比如发号机制，可以单独部署短链生成服务，提前生成一批短链存储到 MySQL 等数据库。亦可以批量读取短链，缓存到内存中。在生成短链时，取出一个 Key 使用，队列长度消耗到一定阈值便补充新的短链。

优化 hash 冲突检测，可以使用布隆过滤器。

### 访问短链服务

短链服务一般读远大于写，可以提前做好读写分离。

缓存热点短链数据。

防止恶意攻击：
- 鉴权
- 可以添加基于用户或IP的限流器