<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Mysql on Trock</title><link>https://ggxxll.github.io/tags/mysql/</link><description>Recent content in Mysql on Trock</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 05 Nov 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://ggxxll.github.io/tags/mysql/index.xml" rel="self" type="application/rss+xml"/><item><title>锁（一）</title><link>https://ggxxll.github.io/p/%E9%94%81%E4%B8%80/</link><pubDate>Sat, 05 Nov 2022 00:00:00 +0000</pubDate><guid>https://ggxxll.github.io/p/%E9%94%81%E4%B8%80/</guid><description>&lt;h3 id="概述">概述&lt;/h3>
&lt;p>锁机制用于管理对共享资源的并发访问。&lt;/p>
&lt;p>锁可大致分为两类：&lt;/p>
&lt;ul>
&lt;li>lock：对象是事务，用来锁定的是数据库中的对象，如表、页、行。并且一般lock的对象仅在事务 commit 或者 rollback 后进行释放。有死锁检测机制。&lt;/li>
&lt;li>latch：闩锁（shuang suo），其要求锁定的时间必须非常短。若持续的时间长，则应用的性能会非常差。在 InnoDB 存储引擎中，latch 又分为
mutex 互斥锁 和 rwLock 读写锁。
其目的是为了保证并发线程操作临界资源的正确性。通常没有死锁的检测机制。&lt;/li>
&lt;/ul>
&lt;h3 id="锁的类型">锁的类型&lt;/h3>
&lt;h4 id="共享锁排他锁">共享锁，排他锁&lt;/h4>
&lt;p>InnoDB存储引擎实现了如下两种标准的行级锁：&lt;/p>
&lt;p>共享锁（S Lock）：允许事务读取一行数据。&lt;/p>
&lt;p>排他锁（X Lock）：允许事务删除或者更新一行数据。&lt;/p>
&lt;p>这里可以理解为读写锁，可并行读，但是不可以：并行写、并行读写。&lt;/p>
&lt;p>排它锁是很强的锁，不与其他类型的锁兼容。这也很好理解，修改和删除某一行的时候，必须获得强锁，禁止这一行上的其他并发，以保障数据的一致性。&lt;/p>
&lt;h4 id="记录锁">记录锁&lt;/h4>
&lt;p>Record Lock，&lt;strong>仅锁定一行记录&lt;/strong>（如共享锁、排他锁）&lt;/p>
&lt;p>记录锁总是会去锁定索引记录，如果表在建立的时候，没有设置任何索引，InnoDB 会使用隐式的主键进行锁定。
查询条件的列是唯一索引的情况下，临键锁退化为记录锁。&lt;/p>
&lt;h4 id="间隙锁">间隙锁&lt;/h4>
&lt;p>Gap Lock，&lt;strong>锁定一个范围，但不包括记录本身&lt;/strong>。
关闭间隙锁的两种方式：&lt;/p>
&lt;ol>
&lt;li>将事务隔离级别设置为 读已提交（read committed）&lt;/li>
&lt;li>将参数 innodb_locks_unsafe_for_binlog 设置为 1&lt;/li>
&lt;/ol>
&lt;p>在上述配置下，除了外键和唯一性检查依然需要间隙锁，其余情况均使用行锁进行锁定。&lt;/p>
&lt;h4 id="临键锁">临键锁&lt;/h4>
&lt;p>Next-Key Lock，等于记录锁+间隙锁，&lt;strong>锁定一个范围，并锁定记录本身&lt;/strong>.&lt;/p>
&lt;p>主要是阻止多个事务将记录插入到同一个范围内，从而避免幻读。&lt;/p>
&lt;p>当查询的索引是唯一索引时，InnoDB 会将临键锁优化为记录锁，从而提高并发。这时候，将不再使用间隙锁来避免幻读。&lt;/p>
&lt;h4 id="意向锁">意向锁&lt;/h4>
&lt;p>事务可能要加共享/排他锁，先提前声明一个意向。&lt;/p>
&lt;p>InnoDB 支持多粒度锁定，这种锁定允许事务在行级上的锁和表级上的锁同时存在。为了支持不同粒度上进行加锁操作，InnoDB
存储引擎支持一种额外的锁方式，
称之为意向锁。意向锁是将锁定的对象分为多个层次，意向锁意味着事务希望在更粗的粒度上进行加锁。&lt;/p>
&lt;p>特点：&lt;/p>
&lt;ol>
&lt;li>意向锁是表级别锁&lt;/li>
&lt;li>意向锁可分为：
&lt;ul>
&lt;li>意向共享锁（intention shared lock, IS）：表示事务有意向对表中的某些行加共享锁&lt;/li>
&lt;li>意向排它锁（intention exclusive lock, IX）：表示事务有意向对表中的某些行加排它锁&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>意向锁协议：
&lt;ul>
&lt;li>事务要获得某些行的共享锁，必须先获得表的意向共享锁 IS&lt;/li>
&lt;li>事务要获取某些行的排他锁，必须先获得表的意向排他锁 IX&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>由于意向锁仅表明意向，所以是比较弱的锁，意向锁之间不互斥，可以并行&lt;/li>
&lt;li>意向锁之间可以并行，但与共享锁和排它锁互斥，表现为 S+IS 可并行读，其他均互斥。&lt;/li>
&lt;/ol>
&lt;h4 id="插入意向锁">插入意向锁&lt;/h4>
&lt;p>对已有数据行的修改与删除，必须使用排他锁，那对于数据的插入，是否还需要加这么强的锁，来实施互斥呢？插入意向锁，孕育而生。&lt;/p>
&lt;p>插入意向锁，是间隙锁（Gap Locks）的一种（所以，也是实施在索引上的），&lt;strong>它是专门针对 INSERT 操作的&lt;/strong>。&lt;/p>
&lt;p>它的用处是：&lt;strong>多个事务，在同一个索引上插入记录时，如果插入的位置不冲突，不会阻塞彼此&lt;/strong>。&lt;/p>
&lt;h4 id="自增锁">自增锁&lt;/h4>
&lt;p>自增锁是 MySQL一种特殊的锁，如果&lt;strong>表中存在自增字段，MySQL便会自动维护一个自增锁&lt;/strong>。&lt;/p>
&lt;p>在 InnoDB 存储引擎的内存结构中，对每个含有自增长值的表都有一个自增长计数器。当对含有自增长计数器的表进行插入操作时，这个计数器会被初始化，执行如下操作来得到计数器的值：&lt;/p>
&lt;p>&lt;code>select max(auto_inc_col) from t for update&lt;/code>&lt;/p>
&lt;p>插入操作会依据这个自增长的计数器值加 1 赋予自增长列。这个实现方式称为 &lt;code>Auto-Inc Locking&lt;/code>。这种锁其实是采用一种表锁的机制，为了提高插入的性能，&lt;strong>自增长锁不是在一个事务完成以后才释放，而是在完成自增长值插入的SQL后立即释放&lt;/strong>。&lt;/p>
&lt;p>虽然 &lt;code>Auto-Inc Locking&lt;/code> 从一定程度上提高了并发插入的效率，但还是存在一些性能上的问题。对于自增长列的并发插入性能较差，事务必须等待前一个插入的完成（虽然不用等待事务的完成）。&lt;/p>
&lt;p>从 MySQL5.12 版本开始，InnoDB 存储引擎提供了一种轻量级互斥量的自增长实现方式。这种方式大大提高了自增长值插入的性能。并且从该版本开始，InnoDB 存储引起提供了一个参数 &lt;code>innodb_innodb_autoinc_lock_mode&lt;/code> 来控制自增长模式，该参数的默认值为 1&lt;/p>
&lt;p>自增长的插入分类:&lt;/p>
&lt;ul>
&lt;li>insert like: 指所有的插入语句，如 INSERT、REPLACE、INSERT&amp;hellip;SELECT、RPELACE&amp;hellip;SELECT、LOAD DATA等&lt;/li>
&lt;li>simple inserts：指能在插入前就确定插入行数的语句，如 INSERT、REPLACE 等。需要注意的是，不包含 INSERT&amp;hellip;ON DUPLICATE KEY
UPDATE 这类语句。&lt;/li>
&lt;li>bulk inserts：指在插入前不能确定插入行数的语句，如 INSERT&amp;hellip;SELECT、RPELACE&amp;hellip;SELECT、LOAD DATA等&lt;/li>
&lt;li>mixed-mode inserts：指插入中有一部分的值是自增长的，有一部分是确定的。如 INSERT INTO T1 (id,name) VALUES (1,&amp;lsquo;A&amp;rsquo;),(
NULL,&amp;lsquo;B&amp;rsquo;)；也可以指 INSERT&amp;hellip;ON DUPLICATE KEY UPDATE 这类语句。&lt;/li>
&lt;/ul>
&lt;p>&lt;code>innodb_innodb_autoinc_lock_mode&lt;/code> 参数值的说明：&lt;/p>
&lt;ul>
&lt;li>0：
&lt;ol>
&lt;li>它提供了一个向后兼容的能力&lt;/li>
&lt;li>在这一模式下，所有的 insert 语句(&amp;ldquo;insert like&amp;rdquo;) 都要在语句开始的时候得到一个表级的 &lt;code>Auto-Inc Locking&lt;/code> 锁，在语句结束的时候才释放这把锁，注意呀，这里说的是语句级而不是事务级的，一个事务可能包涵有一个或多个语句。&lt;/li>
&lt;li>它能保证值分配的可预见性，与连续性，可重复性，这个也就保证了 insert 语句在复制到 slave 的时候还能生成和master那边一样的值(它保证了基于语句复制的安全)。&lt;/li>
&lt;li>由于在这种模式下 &lt;code>Auto-Inc Locking&lt;/code> 锁一直要保持到语句的结束，所以这个就影响到了并发的插入。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>1:
&lt;ol>
&lt;li>这一模式下去 simple insert 做了优化，由于simple insert一次性插入值的个数可以立马得到 确定，所以mysql可以一次生成几个连续的值，用于这个insert语句；总的来说这个对复制也是安全的(它保证了基于语句复制的安全)&lt;/li>
&lt;li>这一模式也是mysql的默认模式，这个模式的好处是 &lt;code>Auto-Inc Locking&lt;/code> 锁不要一直保持到语句的结束，只要语句得到了相应的值后就可以提前释放锁&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>2:
&lt;ol>
&lt;li>由于这个模式下已经没有了 &lt;code>Auto-Inc Locking&lt;/code> 锁，所以这个模式下的性能是最好的；但是它也有一个问题，就是对于同一个语句来说它所得到的 auto_incremant 值可能不是连续的。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;p>InnoDB 存储引擎中自增长的实现和 MyISAM 不同。MyISAM 存储引擎是表锁设计，自增长不用考虑并发插入的问题。在 InnoDB
存储引擎中，自增长值的列必须是索引，同时必须是索引的第一个列，如果不是第一个列，则 MySQL 会抛出异常。MyISAM 存储引擎没有这个问题。&lt;/p></description></item><item><title>ACID</title><link>https://ggxxll.github.io/p/acid/</link><pubDate>Sun, 23 Oct 2022 00:00:00 +0000</pubDate><guid>https://ggxxll.github.io/p/acid/</guid><description>&lt;h3 id="概述">概述&lt;/h3>
&lt;p>ACID，是指数据库管理系统（DBMS）在写入或更新资料的过程中，为保证事务（transaction）是正确可靠的，所必须具备的四个特性：
原子性（atomicity [ˌætəˈmɪsəti]， 或称不可分割性）、一致性（consistency [kənˈsɪstənsi]）、
隔离性（isolation [ˌaɪsəˈleɪʃn]，又称独立性）、持久性（durability [ˌdjʊərəˈbɪlɪti]）。&lt;/p>
&lt;p>在数据库系统中，一个事务是指：由一系列数据库操作组成的一个完整的逻辑过程。例如银行转帐，从原账户扣除金额，以及向目标账户添加金额，这两个数据库操作的总和，构成一个完整的逻辑过程，不可拆分。这个过程被称为一个事务，具有ACID特性。&lt;/p>
&lt;h3 id="特性">特性&lt;/h3>
&lt;ul>
&lt;li>Atomicity（原子性）：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被恢复（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。&lt;/li>
&lt;li>Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。&lt;/li>
&lt;li>Isolation（隔离性）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read
uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。&lt;/li>
&lt;li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。&lt;/li>
&lt;/ul>
&lt;h3 id="事务并发时可能出现的问题">事务并发时可能出现的问题&lt;/h3>
&lt;h4 id="脏读dirty-read">脏读（Dirty Read）&lt;/h4>
&lt;p>A 事务读到了 B 未提交事务修改过的数据&lt;/p>
&lt;h4 id="不可重复读non-repeatable-read">不可重复读（Non-Repeatable Read）&lt;/h4>
&lt;p>A 事务只能读到 B 已经提交的事务修改过的数据，并且其他事务每对该数据进行一次修改并提交后，A 事务都能查询得到最新值。
（不可重复读在读未提交和读已提交隔离级别都可能会出现）&lt;/p>
&lt;h4 id="幻读phantom">幻读（Phantom）&lt;/h4>
&lt;p>A 事务先根据某些条件查询出一些记录，之后 B 事务又向表中插入了符合这些条件的记录，A 事务再次按照该条件查询时，能把 B 事务插入的记录也读出来。
（幻读在读未提交、读已提交、可重复读隔离级别都可能会出现）&lt;/p>
&lt;h3 id="mysql事务的隔离级别">Mysql事务的隔离级别&lt;/h3>
&lt;p>MySQL的事务隔离级别一共有四个，分别是读未提交、读已提交、可重复读以及可串行化。&lt;/p>
&lt;p>MySQL的隔离级别的作用就是让事务之间互相隔离，互不影响，这样可以保证事务的一致性。&lt;/p>
&lt;p>隔离级别比较：可串行化 &amp;gt; 可重复读 &amp;gt; 读已提交 &amp;gt; 读未提交&lt;/p>
&lt;p>隔离级别对性能的影响比较：可串行化 &amp;gt; 可重复读 &amp;gt; 读已提交 &amp;gt; 读未提交&lt;/p>
&lt;p>由此看出，隔离级别越高，所需要消耗的MySQL性能越大（如事务并发严重性），为了平衡二者，一般建议设置的隔离级别为可重复读，MySQL Innodb默认的隔离级别也是可重复读。&lt;/p>
&lt;h4 id="读未提交read-uncommitted">读未提交（READ UNCOMMITTED）&lt;/h4>
&lt;p>在读未提交隔离级别下，事务 A 可以读取到事务B修改过但未提交的数据。&lt;/p>
&lt;p>可能发生脏读、不可重复读和幻读问题，一般很少使用此隔离级别。&lt;/p>
&lt;h4 id="读已提交read-committed">读已提交（READ COMMITTED）&lt;/h4>
&lt;p>在读已提交隔离级别下，事务 B 只能在事务 A 修改过并且已提交后才能读取到事务 B 修改的数据。&lt;/p>
&lt;p>读已提交隔离级别解决了脏读的问题，但可能发生不可重复读和幻读问题，一般很少使用此隔离级别。&lt;/p>
&lt;ol>
&lt;li>普通读是快照读；&lt;/li>
&lt;li>加锁的select, update, delete等语句，除了在外键约束检查(foreign-key constraint checking)以及重复键检查(duplicate-key checking)时会封锁区间，其他时刻都只使用记录锁；&lt;/li>
&lt;/ol>
&lt;h4 id="可重复读repeatable-read">可重复读（REPEATABLE READ）&lt;/h4>
&lt;p>在可重复读隔离级别下，事务 B 只能在事务 A 修改过数据并提交后，B 也提交事务后，才能读取到事务 A 修改的数据。&lt;/p>
&lt;p>可重复读隔离级别解决了脏读和不可重复读的问题，但可能发生幻读问题。&lt;/p>
&lt;blockquote>
&lt;p>提问：为什么上了写锁（写操作），别的事务还可以读操作？&lt;/p>
&lt;/blockquote>
&lt;p>因为InnoDB有MVCC机制（多版本并发控制），可以使用快照读，而不会被阻塞。&lt;/p>
&lt;ol>
&lt;li>普通的select使用快照读(snapshot read)，这是一种不加锁的一致性读(Consistent Nonlocking Read)，底层使用MVCC来实现，具体的原理在《InnoDB并发如此高，原因竟然在这？》中有详细的描述；&lt;/li>
&lt;li>加锁的select(&lt;code>select ... in share mode&lt;/code> | &lt;code>select ... for update&lt;/code>), update, delete等语句，它们的锁，依赖于它们是否在唯一索引(unique index)上使用了唯一的查询条件(unique search condition)，或者范围查询条件(range-type search condition)：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>在唯一索引上使用唯一的查询条件，会使用记录锁(record lock)，而不会封锁记录之间的间隔，即不会使用间隙锁(gap lock)与临键锁(next-key lock)&lt;/li>
&lt;li>范围查询条件，会使用间隙锁与临键锁，锁住索引记录之间的范围，避免范围间插入记录，以避免产生幻影行记录，以及避免不可重复的读&lt;/li>
&lt;/ul>
&lt;h4 id="可串行化serializable">可串行化（SERIALIZABLE）&lt;/h4>
&lt;p>各种问题（脏读、不可重复读、幻读）都不会发生，通过加锁实现（读锁和写锁）。
事务并发执行时，阻塞情况与读写锁相同，可同时读，不可以读写交叉。&lt;/p>
&lt;p>所有select语句都会被隐式的转化为 &lt;code>select ... in share mode&lt;/code>.&lt;/p>
&lt;h3 id="隔离级别比较">隔离级别比较&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>级别&lt;/th>
&lt;th>脏读&lt;/th>
&lt;th>不可重复读&lt;/th>
&lt;th>幻读&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>读未提交&lt;/td>
&lt;td>可能&lt;/td>
&lt;td>可能&lt;/td>
&lt;td>可能&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>读已提交&lt;/td>
&lt;td>不会&lt;/td>
&lt;td>可能&lt;/td>
&lt;td>可能&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>可重复读&lt;/td>
&lt;td>不会&lt;/td>
&lt;td>不会&lt;/td>
&lt;td>可能&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>串行读&lt;/td>
&lt;td>不会&lt;/td>
&lt;td>不会&lt;/td>
&lt;td>不会&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="隔离级别的实现原理">隔离级别的实现原理&lt;/h3>
&lt;p>使用MySQL的默认隔离级别（可重复读）来进行说明。&lt;/p>
&lt;p>每条记录在更新的时候都会同时记录一条回滚操作（回滚操作日志undo log）。同一条记录在系统中可以存在多个版本，这就是数据库的多版本并发控制（MVCC）。
即通过回滚（rollback操作），可以回到前一个状态的值。&lt;/p>
&lt;p>提问：回滚操作日志（undo log）什么时候删除？&lt;/p>
&lt;p>MySQL会判断当没有事务需要用到这些回滚日志的时候，回滚日志会被删除。&lt;/p>
&lt;p>提问：什么时候不需要了？&lt;/p>
&lt;p>当系统里么有比这个回滚日志更早的read-view的时候。&lt;/p>
&lt;h3 id="相关操作">相关操作&lt;/h3>
&lt;h4 id="查看隔离级别">查看隔离级别&lt;/h4>
&lt;ol>
&lt;li>&lt;code>SHOW VARIABLES LIKE 'transaction_isolation';&lt;/code>&lt;/li>
&lt;li>&lt;code>SELECT @@transaction_isolation;&lt;/code>&lt;/li>
&lt;/ol>
&lt;h4 id="设置隔离级别">设置隔离级别&lt;/h4>
&lt;h5 id="set-命令">SET 命令&lt;/h5>
&lt;p>&lt;code>SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL level;&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">其中level有4种值：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">level: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> REPEATABLE READ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | READ COMMITTED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | READ UNCOMMITTED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | SERIALIZABLE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>1.　GLOBAL&lt;/p>
&lt;ul>
&lt;li>只对执行完该语句之后产生的会话起作用&lt;/li>
&lt;li>当前已经存在的会话无效&lt;/li>
&lt;/ul>
&lt;p>2.　SESSION&lt;/p>
&lt;ul>
&lt;li>只对当前会话中下一个即将开启的事务有效&lt;/li>
&lt;li>下一个事务执行完后，后续事务将恢复到之前的隔离级别&lt;/li>
&lt;li>该语句不能在已经开启的事务中间执行，会报错的&lt;/li>
&lt;/ul>
&lt;h5 id="服务启动项命令">服务启动项命令&lt;/h5>
&lt;p>可以修改启动参数transaction-isolation的值&lt;/p>
&lt;p>比方说我们在启动服务器时指定了&amp;ndash;transaction-isolation=READ UNCOMMITTED，那么事务的默认隔离级别就从原来的REPEATABLE READ变成了READ UNCOMMITTED。&lt;/p></description></item><item><title>mysql 的 order by 和 limit 语句导致慢 sql</title><link>https://ggxxll.github.io/p/mysql-%E7%9A%84-order-by-%E5%92%8C-limit-%E8%AF%AD%E5%8F%A5%E5%AF%BC%E8%87%B4%E6%85%A2-sql/</link><pubDate>Mon, 19 Sep 2022 00:00:00 +0000</pubDate><guid>https://ggxxll.github.io/p/mysql-%E7%9A%84-order-by-%E5%92%8C-limit-%E8%AF%AD%E5%8F%A5%E5%AF%BC%E8%87%B4%E6%85%A2-sql/</guid><description>&lt;h3 id="问题">问题&lt;/h3>
&lt;p>&lt;code>order by&lt;/code> 和 &lt;code>limit&lt;/code> 造成优化器选择索引错误&lt;/p>
&lt;h3 id="测试表">测试表&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DATABASE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4_0900_ai_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">created_at&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">timestamp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">deleted_at&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">timestamp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">users_age_IDX&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4_0900_ai_ci&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="填充测试数据">填充测试数据&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PROCEDURE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">addData&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DELIMITER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">$$&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">$$&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PROCEDURE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">addData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">BEGIN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">DECLARE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">while&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">created_at&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">deleted_at&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CONCAT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">End&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">while&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">END&lt;/span>&lt;span class="err">$$&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DELIMITER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CALL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">addData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">400&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="查询-sql">查询 sql&lt;/h3>
&lt;ol>
&lt;li>以下查询中使用的索引正确使用了 &lt;code>users_age_IDX&lt;/code>。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">explain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">limit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">explain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">limit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>select_type&lt;/th>
&lt;th>table&lt;/th>
&lt;th>partitions&lt;/th>
&lt;th>type&lt;/th>
&lt;th>possible_keys&lt;/th>
&lt;th>key&lt;/th>
&lt;th>key_len&lt;/th>
&lt;th>ref&lt;/th>
&lt;th>rows&lt;/th>
&lt;th>filtered&lt;/th>
&lt;th>Extra&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>u&lt;/td>
&lt;td>&lt;/td>
&lt;td>range&lt;/td>
&lt;td>users_age_IDX,users_deleted_at_IDX&lt;/td>
&lt;td>users_age_IDX&lt;/td>
&lt;td>5&lt;/td>
&lt;td>&lt;/td>
&lt;td>1988&lt;/td>
&lt;td>100.0&lt;/td>
&lt;td>Using index condition; Using where&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol start="2">
&lt;li>这个查询中使用的索引是主键, 数据量&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">explain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">u&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">desc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">limit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>select_type&lt;/th>
&lt;th>table&lt;/th>
&lt;th>partitions&lt;/th>
&lt;th>type&lt;/th>
&lt;th>possible_keys&lt;/th>
&lt;th>key&lt;/th>
&lt;th>key_len&lt;/th>
&lt;th>ref&lt;/th>
&lt;th>rows&lt;/th>
&lt;th>filtered&lt;/th>
&lt;th>Extra&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>u&lt;/td>
&lt;td>&lt;/td>
&lt;td>index&lt;/td>
&lt;td>users_age_IDX,users_deleted_at_IDX&lt;/td>
&lt;td>PRIMARY&lt;/td>
&lt;td>4&lt;/td>
&lt;td>&lt;/td>
&lt;td>65&lt;/td>
&lt;td>15.33&lt;/td>
&lt;td>Using where; Backward index scan&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="原因">原因&lt;/h3>
&lt;p>MySQL 优化器认为在 &lt;code>limit&lt;/code> 值较小的情况下，走主键索引能够更快的找到那一条数据，并且如果走联合索引需要扫描索引后进行排序，而主键索引天生有序，所以优化器综合考虑，走了主键索引。&lt;/p></description></item></channel></rss>